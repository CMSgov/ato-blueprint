{% extends "base.html" %}

{% block title %}
Next Question: {{q.title}}
{% endblock %}

{% block body %}

<style>
#question form {
  margin: 1em -15px;
  padding: 1em 15px;
  border: 1px solid #BBB;
}
</style>

{% include "task-status.html" %}

<h1>{{module.title}}</h1>

<div class="row">
  <div class="col-md-6">
    <div id="question" style="margin: 2em 0">
        <form method="post">
            {% csrf_token %}

            <input type="hidden" name="question" value="{{q.id}}">
            <input type="hidden" name="method" value="set">

            {{prompt|safe}}

            {% if q.type == "text" %}
              <div class="form-group">
                <input name="value" type="text" class="form-control" id="inputctrl" placeholder="{{q.placeholder}}" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                <p class="help-block">{{q.help}}</p>
              </div>

            {% elif q.type == "email" %}
              <div class="form-group">
                <input name="value" type="email" class="form-control" id="inputctrl" placeholder="email address" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                <p class="help-block">{{q.help}}</p>
              </div>

            {% elif q.type == "password" %}
              <div class="form-group">
                <input name="value" type="password" class="form-control" id="inputctrl" placeholder="password">
                <p class="help-block">{{q.help}}</p>
              </div>

            {% elif q.type == "longtext" %}
              <div class="form-group">
                <textarea name="value" class="form-control" id="inputctrl" rows="10">{% if answer.value %}{{answer.value}}{% endif %}</textarea>
                <p class="help-block">{{q.help}}</p>
              </div>

            {% elif q.type == "choice" %}
              {% for choice in q.choices %}
              <div class="radio">
                <label>
                  <input name="value" value="{{choice.key}}" type="radio" {% if answer.value == choice.key %}checked{% endif %}> {{choice.text}}
                  <p class="help-block">{{choice.help}}</p>
                </label>
              </div>
              {% endfor %}

            {% elif q.type == "yesno" %}
              <div class="radio">
                <label>
                  <input name="value" value="no"  type="radio" {% if answer.value == "no" %}checked{% endif %}> No
                </label>
              </div>
              <div class="radio">
                <label>
                  <input name="value" value="yes" type="radio" {% if answer.value == "yes" %}checked{% endif %}> Yes
                </label>
              </div>
              <p class="help-block">{{q.help}}</p>

            {% elif q.type == "multiple-choice" %}
              {% for choice in q.choices %}
              <div class="checkbox">
                <label>
                  <input name="value" value="{{choice.key}}" type="checkbox" {% if choice.key in answer.value %}checked{% endif %}> {{choice.text}}
                  <p class="help-block">{{choice.help}}</p>
                </label>
              </div>
              {% endfor %}

              {% if q.choice_selection_min > 0 %}
                  <p class="help-block">You must choose at least {{q.choice_selection_min}} {% if q.choice_selection_max %}and at most {{q.choice_selection_max}}{% endif %} options.</p>
              {% elif q.choice_selection_max %}
                  <p class="help-block">You may choose at most {{q.choice_selection_max}} options.</p>
              {% endif %}

            {% elif q.type == "module" %}
              <div class="form-group">
                <label for="inputctrl">Select a module to answer this question:</label>
                <select name="value" class="form-control" id="inputctrl"
                  onchange="if ($(this).val() == '__invite') invite_user_to_start_module();">
                  <option value="">Select...</option>
                  {% for m in answer_tasks %}
                    <option value="{{m.id}}" {% if m == answer.answered_by_task %}selected{% endif %}>
                      {{m.title}}
                      ({% if answer_tasks_show_user %}Edited by {% if m.editor == request.user %}you{% else %}{{m.editor}}{% endif %}; {% endif %}{{m.get_status_display}})
                    </option>
                  {% endfor %}
                  <option value="__new">Start a new module on {{answer_module.title}}...</option>
                  <option value="__invite">Invite a colleague to answer {{answer_module.title}}...</option>
                </select>
                <p class="help-block">{{q.help}}</p>
              </div>

              <p class="help-block">{{q.help}}</p>

            {% else %}
                {{q.type}}

            {% endif %}

            <button type="submit" class="btn btn-success" {% if not write_priv %}disabled title="Only the editor can change the answer to this question."{% endif %}>
              {% if not request.GET.q %}Next{% else %}Submit{% endif %}
              &raquo;
            </button>

            {% if answer.value and write_priv %}
              <button type="submit" class="btn btn-danger btn-sm"
                onclick="$('#question > form input[name=method]').val('clear')">Clear Answer</button>
            {% endif %}
        </form>     
    </div>
  </div> <!-- /col -->

  <div class="col-md-6">

    <button class="btn btn-info" onclick="$('#need-help').slideToggle();">Get Help From Colleagues</button>

    <ul id="need-help" style="display: none; padding: 0; margin-top: 1.25em">
        <li id="start-a-discussion">
            {# if you can see this page, you can start a conversation #}
            <a href="javascript:start_a_discussion()">Start a team conversation about this question</a>
        </li>
        <li>
          {% if write_priv %}
            <a href="javascript:invite_to_transfer_editor()">Ask a colleague to finish this module</a>
          {% else %}
            The editor of this module can ask a colleague to finish this module
          {% endif %}
        </li>
    </ul>

  </div> <!-- /col -->
</div> <!-- /row -->

{% if DEBUG %}
<p style="margin: 1em 0 2em 0">
  user: <b>{{user}}</b>
  |
  module: <b>{{module.id}}</b>
  |
  question: <b>{{q.id}}</b>
</p>
{% endif %}

{% include "discussion.html" %}

{% endblock %}

{% block scripts %}
<script>
$(function() {
    $('#inputctrl').focus();
    {% if discussion %}
    start_a_discussion(true); // is idempotent
    {% endif %}

    {% if q.type == "text" or q.type == "password" or q.type == "email" or q.type == "longtext" or q.type == "module" %}
    function validate_answer() {
        var val = $('#inputctrl').val();
        if (/^ *$/.exec(val))
            return "You must enter something."
        return undefined;
    }

    {% elif q.type == "choice" %}
    function validate_answer() {
        var val = $('#question input[type="radio"]:checked').val();
        if (!val)
            return "You must make a selection."
        return undefined;
    }

    {% elif q.type == "multiple-choice" %}
    function validate_answer() {
        // Collect the checked values.
        var vals = [];
        $('#question input[type="checkbox"]:checked').each(function() {
            vals.push($(this).val());
        });
        if (vals.length < {{q.choice_selection_min}})
            return "You must choose at least {{q.choice_selection_min}} options.";
        {% if q.choice_selection_max %}
        if (vals.length > {{q.choice_selection_max}})
            return "You must choose at most {{q.choice_selection_max}} options.";
        {% endif %}
        return undefined;
    }

    {% else %}

    function validate_answer() { }
    
    {% endif %}

    var form = $("#question > form");
    form.on("submit", function() {
        // skip client-side validation if user is trying to clear the answer
        if ($('#question form input[name=method]').val() == "clear")
          return true;

        // client-side validation, block form if not valid
        var problem = validate_answer();
        if (problem) {
            alert(problem);
            return false;
        }

        // ok, submit
        return true;
    })
})

{% if q.type == "module" %}
function invite_user_to_start_module() {
  var info = {{send_invitation|safe}};
  show_invite_modal(
    'Ask a Colleague',
    'Invite a colleague to answer the module {{answer_module.title|escapejs}}.',
    info,
    'Can you give me a hand completing the module {{answer_module.title|escapejs}} for ' + info.project_title + '?',
    {
      project: info.project_id,
      into_new_task_module_id: "{{answer_module.id|escapejs}}"
    });

  return false;
}
{% endif %}

function invite_to_transfer_editor() {
  var info = {{send_invitation|safe}};
  show_invite_modal(
    'Ask a Colleague',
    'Invite a colleague to complete {{task.title|escapejs}}.',
    info,
    'Can you take over answering {{task.title|escapejs}} for ' + info.project_title + ' and let me know when it is done?',
    {
      project: info.project_id,
      into_task_editorship: {{task.id}}
    });
  return false;
}

function return_to_requestor(user) {
  var info = {{send_invitation|safe}};
  show_invite_modal(
    'Return This Module',
    'Let the person that requested this module from you know you are finished by inviting them to take back editor ownership of it.',
    info,
    'I finished answering {{task.title|escapejs}}.',
    {
      user_id: user,
      project: info.project_id,
      into_task_editorship: {{task.id}}
    });
  return false;
}

function start_a_discussion(is_page_load) {
    ajax_with_indicator({
        url: "{% url 'start_a_discussion' %}",
        method: "POST",
        data: {
            task: {{task.id}},
            question: "{{q.id|escapejs}}"
        },
        success(res) {
          // replace link that starts discussion with static text
          $('#start-a-discussion').text('Team conversation has been started: see below!');

          // load the discussion
          display_discussion(res, is_page_load);

          // scroll to it if this is from a user action
          if (!is_page_load)
            smooth_scroll_to($("#discussion"));
        }
    })
}
</script>
{% endblock %}