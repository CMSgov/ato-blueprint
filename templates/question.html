{% extends "base.html" %}
{% load q %}

{% block title %}
Next Question: {{q.spec.title}}
{% endblock %}

{% block body %}

<style>
#question form {
  margin: 2em 0;
}
  #question form.disabled label {
    color: #777;
  }

#question-prompt {
  font-weight: bold;
}
</style>


<div class="row">
  <div class="col-sm-push-2 col-sm-8">
    {% include "task-header.html" with col_width="4" col_active="questions" %}

    <div id="question" style="margin: 2em 0">
        <form {% if not write_priv %}class="disabled"{% endif %}>
            <input type="hidden" name="question" value="{{q.id}}">
            <input type="hidden" name="method" value="set">

            <div id="question-prompt">
              {{prompt|safe}}
            </div>

            {% if q.spec.type == "text" %}
              <div class="form-group">
                <input name="value" type="text" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "email-address" %}
              <div class="form-group">
                <input name="value" type="email" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                <p class="help-block">{% if q.spec.help %}{{q.spec.help}}{% else %}Enter an email address.{% endif %}</p>
              </div>

            {% elif q.spec.type == "url" %}
              <div class="form-group">
                <input name="value" type="url" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                <p class="help-block">{% if q.spec.help %}{{q.spec.help}}{% else %}Paste a web address.{% endif %}</p>
              </div>

            {% elif q.spec.type == "password" %}
              <div class="form-group">
                <input name="value" type="password" class="form-control" id="inputctrl" placeholder="password">
                <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "longtext" %}
              <div class="form-group">
                <textarea name="value" class="form-control" id="inputctrl" rows="10">{% if answer.value %}{{answer.value}}{% endif %}</textarea>
                <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "choice" %}
              {% for choice in q.spec.choices %}
              <div class="radio">
                <label>
                  <input name="value" value="{{choice.key}}" type="radio" {% if answer.value == choice.key %}checked{% endif %}> {{choice.text}}
                  <p class="help-block">{{choice.help}}</p>
                </label>
              </div>
              {% endfor %}

            {% elif q.spec.type == "yesno" %}
              <div class="radio">
                <label>
                  <input name="value" value="no"  type="radio" {% if answer.value == "no" %}checked{% endif %}> No
                </label>
              </div>
              <div class="radio">
                <label>
                  <input name="value" value="yes" type="radio" {% if answer.value == "yes" %}checked{% endif %}> Yes
                </label>
              </div>
              <p class="help-block">{{q.spec.help}}</p>

            {% elif q.spec.type == "multiple-choice" %}
              {% for choice in q.spec.choices %}
              <div class="checkbox">
                <label>
                  <input name="value" value="{{choice.key}}" type="checkbox" {% if choice.key in answer.value %}checked{% endif %}> {{choice.text}}
                  <p class="help-block">{{choice.help}}</p>
                </label>
              </div>
              {% endfor %}

              {% if q.spec.min > 0 %}
                  <p class="help-block">You must choose at least {{q.spec.min}} {% if q.spec.max %}and at most {{q.spec.max}}{% endif %} options.</p>
              {% elif q.spec.max %}
                  <p class="help-block">You may choose at most {{q.spec.max}} options.</p>
              {% endif %}

            {% elif q.spec.type == "integer" or q.spec.type == "real" %}
              <div class="form-group">
                {% comment %}
                  The HTML5 number input is a bit confusing in how it handles periods and commas.
                  Browsers seem to currently only support a period or comma as a decimal separator,
                  depending on the lang attribute on the input or HTML. They do not allow 
                  thousands-commas. But we should let users type that in.
                {% endcomment %}
                {% if q.spec.min > -1000 and q.spec.max < 1000 %}
                  {# the range doesn't admit thousands, so we don't need to worry about thousands-commmas #}
                  <input name="value" type="number" {% if q.spec.type == "integer" %}step="1"{% else %}step="any"{% endif %} class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                {% else %}
                  {# to let users enter thousands-commas by using a plain text field #}
                  <input name="value" type="text" pattern="[0-9,\.]+" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer.value %}value="{{answer.value}}"{% endif %}>
                {% endif %}
                <p class="help-block">{{q.spec.help}}</p>
                {% if q.spec.min|default_if_none:"NONE" != "NONE" and q.spec.max|default_if_none:"NONE" != "NONE" %}
                    <p class="help-block">Enter a number from {{q.spec.min}} to {{q.spec.max}}.</p>
                {% elif q.spec.min|default_if_none:"NONE" != "NONE" %}
                    <p class="help-block">Enter a number at least {{q.spec.min}}.</p>
                {% elif q.spec.max|default_if_none:"NONE" != "NONE" %}
                    <p class="help-block">Enter a number at most {{q.spec.max}}.</p>
                {% endif %}
              </div>

            {% elif q.spec.type == "module" and answer_tasks|length == 0 %}
              {# The user must choose or start a module, but there is nothing to choose from, so show a simplified interface. #}

              <p>You will next begin the module {{answer_module.title}}.</p>

              {# must be a radio so the client-side validation passes, but we hide it #}
              <input type="radio" name="value" value="__new" checked style="display: none"/>

            {% elif q.spec.type == "module" %}
              {% if answer.answered_by_task %}
                <p>A module has already been selected to provide the information. You can keep your selection{% if answer_tasks|length > 1 %}, select a different module,{% endif %} or start a new one.</p>
                <div class="radio">
                  <label>
                    <input name="value" value="{{answer.answered_by_task.id}}" type="radio" checked>
                    Use my answers in {{answer.answered_by_task.title}}
                      (<a href="{{answer.answered_by_task.get_absolute_url}}{% if not answer.answered_by_task.is_finished %}/start{% endif %}">view{% if answer_answered_by_task_can_write %}/edit{% endif %}</a>)
                  </label>
                </div>

              {% else %}

                <p>Select an existing module that provides the answers or start a new {{answer_module.title}} module.</p>

              {% endif %}

              {% for m in answer_tasks %}
              {% if m != answer.answered_by_task %}
                <div class="radio">
                  <label>
                    <input name="value" value="{{m.id}}" type="radio">
                      {% if answer.answered_by_task %}Change answers to:<br>{% endif %}
                      {{m.title}}
                      ({% if answer_tasks_show_user %}Edited by {% if m.editor == request.user %}you{% else %}{{m.editor}}{% endif %}; {% endif %}{{m.get_status_display}})
                  </label>
                </div>
              {% endif %}
              {% endfor %}

              <div class="radio">
                <label>
                  <input name="value" value="__new" type="radio">
                  {% if answer.answered_by_task %}
                    Start over by answering
                  {% else %}
                    Start
                  {% endif %}
                  a new {{answer_module.title}} module
                </label>
              </div>

              <p class="help-block">{{q.spec.help}}</p>

            {% else %}
                {{q.spec.type}}

            {% endif %}

            {% if write_priv %}
            <button type="submit" class="btn btn-success"
              onclick="$('#question > form input[name=method]').val('save')">
              {% if not request.GET.q %}Next{% else %}Submit{% endif %}
              &raquo;
            </button>

            {% if answer.is_answered %}
              <button type="submit" class="btn btn-danger btn-sm"
                onclick="$('#question > form input[name=method]').val('clear')">Clear Answer</button>
            {% endif %}
            {% endif %}

            {% if not is_discussion_guest %}
            {% if task.project or task.can_transfer_owner %}
            <button class="btn btn-default" onclick="$('#need-help').slideToggle();return false;">Get Help From Colleagues</button>
            {% endif %}
            {% endif %}
        </form>

        {% if not is_discussion_guest %}

        <ul id="need-help" style="display: none; padding: 0; margin-top: 1.25em">
          {% if task.project %} {# discussions can't be tied to answers of tasks that aren't in a project #}
            <li id="start-a-discussion">
                {# if you can see this page, you can start a conversation #}
                <a href="javascript:start_a_discussion()">Start a team conversation about this question</a>
            </li>
          {% endif %}
          {% if task.can_transfer_owner %}
            <li>
              {% if write_priv %}
                <a href="javascript:invite_to_transfer_editor()">Ask a colleague to finish this {% if q.spec.type == "module" %}{{module.title}}{% endif %} module</a>
              {% else %}
                The editor of this module can ask a colleague to finish this module
              {% endif %}
            </li>
          {% endif %}
        </ul>
        {% endif %}

    </div> <!-- /question -->

    {% include "discussion.html" %}

  </div> <!-- /col -->
</div> <!-- /row -->

{% if DEBUG and 0 %}
<p style="margin: 1em 0 2em 0">
  user: <b>{{user}}</b>
  |
  module: <b>{{module.id}}</b>
  |
  question: <b>{{q.key}}</b>
</p>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
$(function() {
    {% if write_priv %}
      $('#inputctrl').focus();
    {% else %}
      $('#question form input').prop('disabled', true);
    {% endif %}

    {% if discussion %}
    {# a discussion already exists, so show it #}
    start_a_discussion(true); // is idempotent
    {% elif history %}
    show_static_history({{history|json}});
    {% endif %}

    {% if q.spec.type == "text" or q.spec.type == "password" or q.spec.type == "email-address" or q.spec.type == "longtext" or q.spec.type == "integer" or q.spec.type == "real" or q.spec.type == "url" %}
    function validate_answer() {
        var val = $('#inputctrl').val();
        if (/^ *$/.exec(val))
            return "You must enter something."
        return undefined;
    }

    {% elif q.spec.type == "choice" or q.spec.type == "yesno" or q.spec.type == "module" %}
    function validate_answer() {
        var val = $('#question input[type="radio"]:checked').val();
        if (!val)
            return "You must make a selection."
        return undefined;
    }

    {% elif q.spec.type == "multiple-choice" %}
    function validate_answer() {
        // Collect the checked values.
        var vals = [];
        $('#question input[type="checkbox"]:checked').each(function() {
            vals.push($(this).val());
        });
        if (vals.length < {{q.spec.min}})
            return "You must choose at least {{q.spec.min}} options.";
        {% if q.spec.max %}
        if (vals.length > {{q.spec.max}})
            return "You must choose at most {{q.spec.max}} options.";
        {% endif %}
        return undefined;
    }

    {% else %}

    function validate_answer() { }
    
    {% endif %}

    var form = $("#question > form");
    form.on("submit", function() {
        var form = $('#question form');

        // skip client-side validation if user is trying to clear the answer
        if (form.find('input[name=method]').val() != "clear") {
          // client-side validation, block form if not valid
          var problem = validate_answer();
          if (problem) {
              alert(problem);
              return false;
          }
        }

        ajax_with_indicator({
            url: window.location.pathname,
            method: "POST",
            data: form.serialize(),
            success: function(res) {
              window.location = res.redirect;
            }
        });

        // don't do an actual <form> submit
        return false;
    });
})

function start_a_discussion(is_page_load) {
    ajax_with_indicator({
        url: "{% url 'start_a_discussion' %}",
        method: "POST",
        data: {
            task: {{task.id}},
            question: "{{q.id|escapejs}}"
        },
        success(res) {
          // replace link that starts discussion with static text
          $('#start-a-discussion').text('Team conversation has been started: see below!');

          // load the discussion
          display_discussion(res, is_page_load);

          // scroll to it if this is from a user action
          if (!is_page_load)
            smooth_scroll_to($("#discussion"));
        }
    })
}

function show_static_history(history) {
  // There's no discussion yet, but we do have activity.
  $('#discussion').show();
  history.forEach(function(item) {
      render_event(item)
    });
}
</script>
{% endblock %}