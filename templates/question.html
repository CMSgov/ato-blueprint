{% extends "base.html" %}
{% load q %}

{% block title %}
Next Question: {{q.spec.title}} | {{task.title}}
{% endblock %}

{% block body %}

<style>
#question {
  margin: 2em 0;
}
  #question form.disabled label {
    color: #777;
  }

{% if q.spec.type == "interstitial" %}
#question-prompt {
  margin: 20px 0;
}
  #question img {
    display: block; /* so that horizontal auto margin centers */
    margin: 30px auto;
  }
{% endif %}

</style>


<div class="row">
  <div class="col-sm-push-1 col-sm-9">
    {% include "task-header.html" with col_width="4" col_active="questions" %}

    {% if source_invitation %}
      <div style="margin-top: 1.5em">
        <div id="source-invitation-show" style="text-align: right; margin-bottom: -1.5em; {% if not task.is_started %}display: none;{% endif %}">
          <a href="#" onclick="$('#source-invitation').fadeIn(); $('#source-invitation-show').hide(); return false;" style="color: #448; font-size: 85%">
            Show Invitation from {{source_invitation.from_user}}
          </a>
        </div>
        
        <div id="source-invitation" class="alert alert-warning alert-dismissible" {% if task.is_started %}style="display: none"{% endif %} role="alert">
          <button type="button" class="close" aria-label="Close" onclick="$('#source-invitation').hide(); $('#source-invitation-show').show();"><span aria-hidden="true">&times;</span></button>
          <strong>Invitation from {{source_invitation.from_user}}:</strong>
          {{source_invitation.text}}
        </div>
      </div>
    {% endif %}

    <div id="question">
        <form {% if not write_priv %}class="disabled"{% endif %}>
            <input type="hidden" name="question" value="{{q.id}}">
            <input type="hidden" name="method" value="save">

            <div id="question-prompt">
              {{prompt|safe}}
            </div>

            {% if q.spec.type == "text" %}
              <div class="form-group">
                <input name="value" type="text" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer %}value="{{answer}}"{% endif %}>
                <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "email-address" %}
              <div class="form-group">
                <input name="value" type="email" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer %}value="{{answer}}"{% endif %}>
                <p class="help-block">{% if q.spec.help %}{{q.spec.help}}{% else %}Enter an email address.{% endif %}</p>
              </div>

            {% elif q.spec.type == "url" %}
              <div class="form-group">
                <input name="value" type="url" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer %}value="{{answer}}"{% endif %}>
                <p class="help-block">{% if q.spec.help %}{{q.spec.help}}{% else %}Paste a web address.{% endif %}</p>
              </div>

            {% elif q.spec.type == "password" %}
              <div class="form-group">
                <input name="value" type="password" class="form-control" id="inputctrl" placeholder="password">
                <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "longtext" %}
              <div class="form-group">
                <textarea name="value" class="form-control" id="inputctrl" rows="10">{% if answer %}{{answer}}{% endif %}</textarea>
                <p class="help-block">{{q.spec.help}}</p>

              </div>

            {% elif q.spec.type == "date" %}
              {# need a shim for most browsers #}
              <div class="form-group">
                <input name="value" type="date" class="form-control" id="inputctrl" style="width: auto"
                   {% if answer %}value="{{answer}}"{% endif %}>
                <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "choice" %}
              <div style="margin: 1em 0 1.5em 0">
              {% for choice in q.spec.choices %}
              <div class="radio">
                <label>
                  <input name="value" value="{{choice.key}}" type="radio" {% if answer == choice.key %}checked{% endif %}> {{choice.text}}
                  <p class="help-block">{{choice.help}}</p>
                </label>
              </div>
              {% endfor %}
              </div>

            {% elif q.spec.type == "yesno" %}
              <div style="margin: 1em 0 1.5em 0">
              <div class="radio">
                <label>
                  <input name="value" value="no"  type="radio" {% if answer == "no" %}checked{% endif %}> No
                </label>
              </div>
              <div class="radio">
                <label>
                  <input name="value" value="yes" type="radio" {% if answer == "yes" %}checked{% endif %}> Yes
                </label>
              </div>
              <p class="help-block">{{q.spec.help}}</p>
              </div>

            {% elif q.spec.type == "multiple-choice" %}
              <div style="margin: 1em 0 1.5em 0">
              {% for choice in q.spec.choices %}
              <div class="checkbox">
                <label>
                  <input name="value" value="{{choice.key}}" type="checkbox" {% if choice.key in answer %}checked{% endif %}> {{choice.text}}
                  <p class="help-block">{{choice.help}}</p>
                </label>
              </div>
              {% endfor %}

              {% if q.spec.min > 0 %}
                  <p class="help-block">You must choose at least {{q.spec.min}} {% if q.spec.max %}and at most {{q.spec.max}}{% endif %} options.</p>
              {% elif q.spec.max %}
                  <p class="help-block">You may choose at most {{q.spec.max}} options.</p>
              {% endif %}
              </div>

            {% elif q.spec.type == "integer" or q.spec.type == "real" %}
              <div class="form-group">
                {% comment %}
                  The HTML5 number input is a bit confusing in how it handles periods and commas.
                  Browsers seem to currently only support a period or comma as a decimal separator,
                  depending on the lang attribute on the input or HTML. They do not allow 
                  thousands-commas. But we should let users type that in.
                {% endcomment %}
                {% if q.spec.min > -1000 and q.spec.max < 1000 %}
                  {# the range doesn't admit thousands, so we don't need to worry about thousands-commmas #}
                  <input name="value" type="number" {% if q.spec.type == "integer" %}step="1"{% else %}step="any"{% endif %} class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer %}value="{{answer}}"{% endif %}>
                {% else %}
                  {# to let users enter thousands-commas by using a plain text field #}
                  <input name="value" type="text" pattern="[0-9,\.]+" class="form-control" id="inputctrl" placeholder="{{q.spec.placeholder}}" {% if answer %}value="{{answer}}"{% endif %}>
                {% endif %}
                <p class="help-block">{{q.spec.help}}</p>
                {% if q.spec.min|default_if_none:"NONE" != "NONE" and q.spec.max|default_if_none:"NONE" != "NONE" %}
                    <p class="help-block">Enter a number from {{q.spec.min}} to {{q.spec.max}}.</p>
                {% elif q.spec.min|default_if_none:"NONE" != "NONE" %}
                    <p class="help-block">Enter a number at least {{q.spec.min}}.</p>
                {% elif q.spec.max|default_if_none:"NONE" != "NONE" %}
                    <p class="help-block">Enter a number at most {{q.spec.max}}.</p>
                {% endif %}
              </div>

            {% elif q.spec.type == "file" %}
              {# When there is an existing answer, the UI shows a thumbnail of it. If the user doesn't choose a new file, the existing value is kept. #}
              {% if answer %}
              <div style="margin: 1em 0">
                <p>The following file is uploaded:</p>
                {% if answer.type|slice:"0:6" == "image/" %}
                	<div style="margin: 1em 0;">
                		<img src="{{answer.url}}" class="img-responsive" style="border: 1px solid black"/>
                	</div>
                {% else %}
                	<p><a href="{{answer.url}}">Download</a></p>
                {% endif %}
                <p>Size: {{answer.size|filesizeformat}}</p>
                <p>Select a new file if you would like to replace it:</p>
              </div>
              {% endif %}

              <div class="form-group">
                <input name="value" type="file" id="inputctrl" class="form-control"
                  style="width: auto; border:  none; padding: 0; display: inline-block"/>
                <input type="reset" value="x" style="font-size: 14px;">
                <p class="help-block">{{q.spec.help}}</p>
              </div>


            {% elif q.spec.type == "module" and answer_tasks|length == 0 %}
              {# The user must choose or start a module, but there is nothing to choose from, so show a simplified interface. #}

              <p>You will next begin the module {{answer_module.title}}.</p>

              {# must be a radio so the client-side validation passes, but we hide it #}
              <input type="radio" name="value" value="__new" checked style="display: none"/>

            {% elif q.spec.type == "module" %}
              {% with current_answer=answer_obj.answered_by_task.first %}

              {% for m in answer_tasks %}
                <div class="radio">
                  <label>
                    <input name="value" value="{{m.id}}" type="radio" {% if m == current_answer %}checked{% endif %}>
                      {{m.render_title}}
                      <span style="color: #777">
                      ({% if answer_tasks_show_user %}Edited by {% if m.editor == request.user %}you{% else %}{{m.editor}}{% endif %}; {% endif %}{{m.get_status_display}})
                      </span>
                      {% if m == current_answer %}
                        <div class="text-info small">(current answer)</div>
                      {% endif %}
                  </label>
                </div>
              {% endfor %}

              <div class="radio">
                <label>
                  <input name="value" value="__new" type="radio">
                  {% if current_answer %}
                    Start over and create
                  {% else %}
                    Create
                  {% endif %}
                  a new {{answer_module.title}}
                </label>
              </div>

              <p class="help-block">{{q.spec.help}}</p>
              {% endwith %}

            {% elif q.spec.type == "interstitial" %}
              {# no other content but an empty value #}
              <input type="hidden" name="value" value=""/>

            {% elif q.spec.type == "external-function" %}
              {# no other content but an empty value #}
              <input type="hidden" name="value" value=""/>

            {% else %}
              <p class="text-danger">QUESTION TYPE NOT IMPLEMENTED: {{q.spec.type}}</p>

            {% endif %}

            {% if answer_obj.answered_by_reference %}
            <p class="text-info">
              This question cannot be changed because it is linked to another question.
            </p>
            {% endif %}

            {% if write_priv %}
            <button id="save-button"
              type="submit" class="btn btn-success"
              onclick="$('#question > form input[name=method]').val('save')">
              {% if q.spec.type == "interstitial" %}
                Got it
              {% elif not request.GET.q %}
                {# user is proceeding through the questions in order #}
                Next
              {% else %}
                Update
              {% endif %}
              &raquo;
            </button>

            {% if q.spec.type != "interstitial" %}

            <button id="skip-button"
              type="submit" class="btn btn-info"
              onclick="$('#question > form input[name=method]').val('skip')">
              {% if not answer %}
              Skip
              {% else %}
              Clear
              {% endif %}
              &raquo;
            </button>

            {% if answer_obj %}
              <button id="clear-button"
                type="submit" class="btn btn-danger"
                onclick="$('#question > form input[name=method]').val('clear')">
                  Reset
                  &raquo;
                </button>
            {% endif %}

            {% if not is_discussion_guest %}
            {% if not task.project.is_account_project or task.can_transfer_owner %}
            <button id="ask-team-show-options" class="btn btn-default" onclick="$('#need-help').slideToggle(); return false;">Ask team</button>
            {% endif %}
            {% endif %}

            {% endif %} {# not interstitial #}

            {% endif %} {# write_priv #}
        </form>

        {% if not is_discussion_guest %}

        <ul id="need-help" style="display: none; padding: 0; margin-top: 1.25em">
          {% if not task.project.is_account_project %} {# discussions can't be tied to answers of tasks that aren't in a project #}
            <li id="start-a-discussion">
                {# if you can see this page, you can start a conversation #}
                <a href="javascript:start_a_discussion()">Start team conversation to decide answer</a>
            </li>
          {% endif %}
          {% if task.can_transfer_owner %}
            <li id="transfer-editorship">
              {% if write_priv %}
                <a href="javascript:invite_to_transfer_editor()">Ask team member to finish this {% if q.spec.type == "module" %}{{module.title}}{% endif %} module</a>
              {% else %}
                The editor of this module can ask a colleague to finish this module
              {% endif %}
            </li>
          {% endif %}
        </ul>
        {% endif %}

    </div> <!-- /question -->

    {% include "discussion.html" %}

  </div> <!-- /col -->
</div> <!-- /row -->

{% endblock %}

{% block scripts %}
{% if DEBUG %}
<div class="container" style="color: #999; font-size: 80%; margin-top: 50px">
<p>
  module: {{m.key}} {% if not m.visible %}(obsolete){% endif %} | question: {{q.key}}
</p>
{% endif %}
</div>

<script>
$(function() {
    var form = $("#question > form");

    {% if write_priv %}
      $('#inputctrl').focus();
    {% else %}
      form.find('input, textarea').prop('disabled', true);
    {% endif %}

    {% if discussion %}
    {# a discussion already exists, so show it #}
    start_a_discussion(true); // is idempotent
    {% elif history %}
    show_static_history({{history|json}});
    {% endif %}

    // BUTTON STATE

    function update_save_skip_clear_state() {
      {% if answer %}
      // If the answer is unchanged, change the submit button text.
      $('#save-button').text(
        (!is_answer_unchanged() ? "Update »" : "Keep »")
      );
      {% endif %}

      // The save/skip/clear buttons are enabled depending on whether
      // something valid has been entered.
      var ok = (typeof validate_answer()) == "undefined";
      $('#save-button').prop('disabled', !ok);

      // If there is an existing answer, the skip/clear buttons remain
      // enabled always so that the answer can be cleared. Some question
      // types don't have an unanswered/invalid state that would otherwise
      // make these buttons enabled.
      {% if answer %}ok = false;{% endif %}
      $('#skip-button').prop('disabled', ok);
      $('#clear-button').prop('disabled', ok);
    }

    on_input_changed(update_save_skip_clear_state); // register event handler
    update_save_skip_clear_state(); // run initially

    // INSTRUMENTATION

    // register event handler
    on_input_changed(record_interaction);

    // VALIDATION

    {% if q.spec.type == "text" or q.spec.type == "password" or q.spec.type == "email-address" or q.spec.type == "longtext" or q.spec.type == "integer" or q.spec.type == "real" or q.spec.type == "url" or q.spec.type == "date" %}
    
    function validate_answer() {
        var val = $('#inputctrl').val();
        if (/^ *$/.exec(val))
            return "You must enter something."
        return undefined;
    }
    function on_input_changed(handler) {
      $('#inputctrl').change(handler);
      $('#inputctrl').on('keyup', handler);
    }
    {% if q.spec.type == "text" or q.spec.type == "email-address" or q.spec.type == "longtext" or q.spec.type == "url" %}
    function is_answer_unchanged() {
      var val = $('#inputctrl').val();
      if (val == "{{answer|escapejs}}")
        return true;
    }
    {# TODO: for integer, real, and date questions, we need to parse the value #}
    {% else %}
    {# dont reval for password-type questions #}
    function is_answer_unchanged() { }
    {% endif %}

    {% elif q.spec.type == "choice" or q.spec.type == "yesno" or q.spec.type == "module" %}

    function validate_answer() {
        var val = $('#question input[type="radio"]:checked').val();
        if (!val)
            return "You must make a selection."
        return undefined;
    }
    function on_input_changed(handler) {
      form.find('input').click(handler);
    }
    function is_answer_unchanged() { }

    {% elif q.spec.type == "multiple-choice" %}

    function validate_answer() {
        // Collect the checked values.
        var vals = [];
        form.find('input[type="checkbox"]:checked').each(function() {
            vals.push($(this).val());
        });
        if (vals.length < {{q.spec.min}})
            return "You must choose at least {{q.spec.min}} options.";
        {% if q.spec.max %}
        if (vals.length > {{q.spec.max}})
            return "You must choose at most {{q.spec.max}} options.";
        {% endif %}
        return undefined;
    }
    function on_input_changed(handler) {
      form.find('input').click(handler);
    }
    function is_answer_unchanged() { }

    {% elif q.spec.type == "file" %}

    function validate_answer() {
      {% if answer %}
      // There is an existing uploaded file. If the user doesn't
      // choose a new file, then Submit just keeps the old value.
      return undefined;
      {% endif %}
      var ctrl = $('#inputctrl')[0];
      if (ctrl.files.length == 0)
        return "Select a file to upload.";
      return undefined;
    }
    function on_input_changed(handler) {
      // Add the handler to the file input control.
      $('#inputctrl').change(handler);

      // Add the handler to the reset button, but it has to be
      // run after this event is finished to occur after the
      // form state is reset.
      $('form input[type=reset]').click(function() { setTimeout(handler, 0); });
    }
    function is_answer_unchanged() {
      var ctrl = $('#inputctrl')[0];
      if (ctrl.files.length == 0)
        return true;
    }

    {% else %}

    // other question types are considered always valid
    function validate_answer() { }
    function is_answer_unchanged() { }
    function on_input_changed(handler) { }

    {% endif %}

    form.on("submit", function() {
        // Get the <form> element.
        var form = $('#question form');

        // Run client-side validation.
        var method = form.find('input[name=method]').val();
        if (method == "save") {
          // client-side validation, block form if not valid
          var problem = validate_answer();
          if (problem) {
              alert(problem);
              return false;
          }
        }

        // Assemble the form submission data.
        //
        // While this would normally work:
        //
        // var data = form.serialize();
        //
        // it does not handle file uploads. For file uploads
        // we must use a FormData object. We could assemble
        // the FormData instance by hand:
        //
        // var form_fields = form.serializeArray();
        // for (var i in form_fields)
        //  data.append(form_fields[i].name, form_fields[i].value);
        // data.append('value', $('#inputctrl')[0].files[0]);
        //
        // But there's a constructor that does this for us:
        var data = new FormData($('form')[0]);
        ajax_with_indicator({
            url: window.location.pathname,
            method: "POST",
            data: data,
            keep_indicator_forever: true, // keep the ajax indicator up forever --- it'll go away when we issue the redirect
            success: function(res) {
              window.location = res.redirect;
            }
        });

        // don't do an actual <form> submit
        return false;
    });
})

function start_a_discussion(is_page_load) {
    ajax_with_indicator({
        url: "{% url 'start_a_discussion' %}",
        method: "POST",
        data: {
            task: {{task.id}},
            question: "{{q.id|escapejs}}"
        },
        success: function(res) {
          // replace link that starts discussion with static text
          $('#start-a-discussion').text('Team conversation has been started: see below!');

          // load the discussion
          display_discussion(res, is_page_load);

          // scroll to it if this is from a user action
          if (!is_page_load)
            smooth_scroll_to($("#discussion"));
        }
    })
}

function show_static_history(history) {
  // There's no discussion yet, but we do have activity.
  $('#discussion').show();
  history.forEach(function(item) {
      render_event(item)
    });
}

var sent_first_interaction = false;
function record_interaction() {
  if (sent_first_interaction)
    return;
  $.ajax({
    url: "{% url 'task_instrumentation_record_interaction' %}",
    method: "POST",
    data: {
      task: {{task.id}},
      question: {{q.id}}
    }
  })
  sent_first_interaction = true;
}
</script>
{% endblock %}