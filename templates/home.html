{% extends "base.html" %}

{% block title %}
Home
{% endblock %}

{% block body %}
<h1 style="margin: 1em 0">Home</h1>

<div style="margin: 2em 0">
<p>You can continue working on a module you have already started or start a new module.</p>
</div>

<div style="float: right; margin-bottom: 1em">
  <a href="/tasks/new-project" class="btn btn-success"><i class="glyphicon glyphicon-plus"></i> New Project</a>
</div>
<div class="clearfix"> </div>

{% for item in projects %}
<div class="panel panel-primary">
  <div class="panel-heading">
    <h3 style="margin: 0">
      {% if item.project %}
        {{item.project.title}}
      {% else %}
        Account Modules
      {% endif %}
    </h3>
  </div>
  <div class="panel-body">
    {% if item.open_invitations %}
      <h4>Invitations waiting for a response...</h4>
      <div class="invitation-list">
      {% for inv in item.open_invitations %}
        <p data-id="{{inv.id}}" title="{{inv.text}}">
          On {{inv.created|date}} you invited {{inv.to_display}} {{inv.purpose}}.
          (<a href="javascript:cancel_invitation({{inv.id}});">cancel</a>)
        </p>
      {% endfor %}
      </div>
    {% endif %}

    {% if item.project %}<h4>Modules you are editing</h4>{% endif %}
    {% if item.tasks|length %}
      {% for task in item.tasks %}
        <p><a href="{{task.get_absolute_url}}{% if not task.is_finished %}/start{% endif %}">{{task.title}}</a> ({{task.get_status_display}})</p>
      {% endfor %}
    {% endif %}
    {% if item.tasks|length == 0 %}
      <p>You have not started any modules in this project.</p>
    {% endif %}

    {% if item.others_tasks|length %}
      <h4>Other modules in this project (edited by others)</h4>
      {% for task in item.others_tasks %}
        <p><a href="{{task.get_absolute_url}}">{{task.title}}</a> (edited by {{task.editor}}; {{task.get_status_display}})</p>
      {% endfor %}
    {% endif %}

    {% if item.project %}
      {# can only start a new module within a project #}
      <hr>

      <form class="form-inline" method="get" action="/tasks/start" onsubmit="if ($('#start-module-{{item.project.id}}').val() == '') { alert('Select a module.'); return false; }">
        <input type="hidden" name="project" value="{{item.project.id}}"/>
        {% csrf_token %}
        <div class="form-group" style="margin-right: 1em">
          <label for="start-module-{{item.project.id}}">Start answering a new module...</label>
          <br>
          <select id="start-module-{{item.project.id}}" class="form-control" name="module">
            <option value="">Select...</option>
            {% for m in item.startable_modules %}
              <option value="{{m.id}}">{{m.title}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group" style="margin-right: 1em">
          <script>var project_invitation_info_{{item.project.id}} = {{item.send_invitation|safe}};</script>
          <label></label>
          <br>
          <button type="submit" class="btn btn-primary">Start Module</button>
          <button class="btn btn-warning" onclick="return invite_user_to_start_module(project_invitation_info_{{item.project.id}});">Invite to Answer ...</button>
        </div>
      </form>
    {% endif %}
  </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
function invite_user_to_start_module(info) {
  var m = $('#start-module-' + info.project_id);
  if (m.val() == '') {
    alert('Select a module.');
    return false;
  }

  var mt = m.find('option[value=' + m.val() + ']').text();

  show_invite_modal(
    'Start a Module (' + info.project_title + ')',
    'Invite a colleague to answer the module ' + mt + '.',
    info,
    'Can you give me a hand completing the module ' + mt + ' for ' + info.project_title + '?',
    {
      project: info.project_id,
      into_new_task_module_id: m.val()
    },
    function() { window.location.reload() }
  );

  return false;
}

function cancel_invitation(invid) {
  ajax_with_indicator({
   url: '{% url "cancel_invitation" %}',
   method: "POST",
   data: {
    id: invid
   },
   success: function(res) {
     show_modal_error("Cancel Invitation", "The invitation has been canceled.");
     var n = $('.invitation-list p[data-id=' + invid + ']');
     n.slideUp(function() { n.remove(); })
   }
  });
}
</script>
{% endblock %}