{% load static %}
<script src="https://cdn.jsdelivr.net/emojione/2.1.4/lib/js/emojione.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/emojione/2.1.4/assets/css/emojione.min.css"/>

<script src="{% static "vendor/push.js" %}"> </script>

<style>
#discussion .comment-thread {
  margin: 1em 0 1.5em 0;
}

#discussion .comment.author-is-self.panel {
  border-color: #ddf;
}
#discussion .comment.author-is-self .panel-heading {
  /* copied from bootstrap theme for panel-info */
  background-image: -webkit-linear-gradient(#d9edf7 0%, #c4e3f3 100%);
  background-image: -o-linear-gradient(#d9edf7 0%, #c4e3f3 100%);
  background-image: linear-gradient(#d9edf7 0%, #c4e3f3 100%);
  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffd9edf7', endColorstr='#ffc4e3f3', GradientType=0);
}

#discussion .comment .comment-avatar {
  border: 1px solid #CCC;
  margin-right: .5em;
  max-width: 25px;
  max-height: 25px; /* same as line height */
}
#discussion .comment .username {
  color: black;
}
#discussion .comment .comment-author-role {
  border: 1px solid #AAA;
  font-size: 90%;
  padding: 2px 4px;
}
#discussion .comment .proposed-answer {
  margin: 1em 0;
  border: 1px solid #EEE;
  padding: .5em 2em .5em 1em;
}
#discussion .comment .commands {
  margin: 0 -15px -15px -15px;
  padding: 10px 15px;
  border-top: 1px solid #EEE;
  font-size: 11px;
}
#discussion .comment .commands a {
  margin-right: 1em;
}
#discussion .comment .commands .react-with-emoji {
  color: #999;
}
  #discussion .comment .commands .react-with-emoji:hover {
    color: #00A;
  }
#discussion .comment .ifeditpriv { display: none; }
#discussion .comment.has-edit-priv .ifeditpriv { display: inline; }
#discussion .comment.author-is-self .ifnotauthor { display: none; }
#discussion .comment .reply {
  margin-top: 1.25em;
}
#discussion .event {
  margin: 15px 0;
}
#discussion .event .event-icon {
  float: left;
}
  #discussion .event .event-icon img {
    max-width: 37px;
    max-height: 37px; /* same as the height of the rest of the event */
    border: 1px solid #CCC;
    margin: 0 .75em .5em 0;
  }
#discussion .event .event-info {
  font-size: 85%;
  color: #555;
}
#discussion .event .event-info > div {
  display: inline;
  padding-bottom: 5px;
  border-top: 1px solid #AAA;
}

#emoji-selector .emoji {
  display: inline-block;
  margin-right: 1px;
  cursor: pointer;
  padding: 3px;
}
  .emojione { margin: 0; }
  #emoji-selector .emoji.active {
    padding: 2px;
    border: 1px solid #DDE;
    background-color: #EEF;
  }
</style>

<div id="discussion" style="display: none;">
  <h2>Activity</h2>

    <div class="comment-thread">
      
    </div>
    <div class="comment-input active-discussion-only" style="display: none">
      <form onsubmit="submit_comment(); return false;">
        <label id="discussion-your-comment-label" for="discussion-your-comment">
          ...
        </label>
        <textarea id="discussion-your-comment" class="form-control" rows="3" placeholder="Enter your message here."></textarea>
        <div style="margin-top: 1em; text-align: right">
          {# <button type="submit" class="btn btn-default">Propose an Answer</button> #}
          <button type="submit" class="btn btn-primary">Comment</button>
        </div>
      </form>
    </div>

    <p id="discussion-you-are-alone" style="display: none" class="text-danger">
      You are the only person in this conversation so far. <a href="#" onclick="return invite_user_to_discussion()" class="btn btn-link btn-default">Invite a colleague</a> to join you.
    </p>

    <p class="small active-discussion-only" style="display: none">
      Who can see this conversation? <span class="fillin-project_name"></span> members<span class="fillin-guests"></span>.
      <a id="invite-guest" href="#" onclick="return invite_user_to_discussion()">Invite Colleague</a>
    </p>
</div>

<div id="comment-template" style="display: none">
  <div class="comment panel panel-default">
    <div class="panel-heading">
      <img class="comment-avatar" style="display: none">
      <span class="comment-author">...</span>
      <span class="comment-author-role"></span>
      commented <span class="comment-date"></span>
    </div>
    <div class="panel-body">
      <div class="comment-text"> </div>
      <form class="comment-edit clearfix" style="display: none" onsubmit="do_comment_save(this); return false;">
        <textarea class="form-control" style="width: 100%;"> </textarea>
        <div style="margin: 1em 0; float: right">
          <button type="submit" class="btn btn-cancel" onclick="return close_comment_edit(this);">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>

      {% comment %}
      <div class="proposed-answer">
        <div class="radio">
          <label>
            <input type="radio" disabled> No
          </label>
        </div>
        <div class="radio">
          <label>
            <input type="radio" checked disabled> Yes
          </label>
        </div>
      </div>
      {% endcomment %}

      <div class="commands">
          <a title="Edit your comment" class="ifeditpriv" href="#" onclick="return begin_comment_edit(this);">
            <i class="glyphicon glyphicon-pencil"></i>
          </a>
          <span class="emoji-reactions">
          </span>
          <a id="react-with-emoji" title="React to this comment with an emoji" class="ifnotauthor react-with-emoji" href="#" onclick="return begin_emoji_reaction(event, this);">
            <i class="glyphicon glyphicon-plus"></i>
            <i class="glyphicon glyphicon-heart"></i>
          </a>
          <a title="Delete this comment" class="ifeditpriv" href="#" onclick="return do_delete_comment(this);">
            <i class="glyphicon glyphicon-trash"></i>
          </a>
      </div>

      <div class="reactions">
      </div>
    </div>
  </div>
</div>

<div id="reply-template" style="display: none">
  <div class="reply">
    <span class="comment-author">...</span>
    <span class="comment-author-role"></span>
    reacted
    <span class="comment-emojis"></span>
    <span class="comment-date"></span>
  </div>
</div>

<div id="event-template" style="display: none">
  <div class="event">
    <div class="event-icon"><img style="display: none"></div>
    <div class="body"> </div>
    <div>
      <div class="event-info">
        <div>
          <span class="event-date"></span>
          <span class="event-who"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="emoji-selector" style="display: none; border-top: 10px solid rgba(255,255,255, .5); border-left: 10px solid rgba(255,255,255, .5);">
  <div class="panel panel-default" style="margin: 0">
    <div class="panel-heading" style="padding: 5px 15px;">
      <button type="button" class="close" aria-label="Close" onclick="save_emoji_reaction()">
        <span aria-hidden="true">&times;</span>
      </button>
      <b>React with an emoji</b>
    </div>
    <div class="panel-body">
      <div>
      </div>  
      <div>
        <div class="emoji" title="React with a heart!">heart</div>
        <div class="emoji" title="React with a thumbs-up!">thumbsup</div>
        <div class="emoji" title="React with a thumbs-down!">thumbsdown</div>
        <div class="emoji" title="React with a smiley face!">smile</div>
        <div class="emoji" title="React with a frowning face!">slight_frown</div>
      </div>
    </div>
    </div>
  </div>

<script>

function init_discussion_html() {
  // Clicks outside of the emoji-selector trigger closing & saving the dialog.
  $(document).click(save_emoji_reaction);
  $('#emoji-selector').click(function(event) { event.stopPropagation(); });
  $('#emoji-selector .emoji').each(function() {
    // Initialize - replace text in markup with images.
    var shortname = $(this).text();
    $(this)
      .html(emojione.toImage(":" + shortname + ":"))
      .click(function() { $(this).toggleClass('active'); })
      .attr('data-emoji-name', shortname);
  });
};

var discussion_info = { max_event_time: 0 };
var discussion_has_any_comment = false;
var discussion_has_any_comment_from_someone_else = false;

function display_discussion(discussion, is_page_load) {
  // first time initialization
  if (window.init_discussion_html)
    init_discussion_html();
  else
    delete window.init_discussion_html;

  // remember what discussion is displayed
  discussion_info = discussion.discussion;

  // show the discussion
  $('#discussion').show();
  $('#discussion .active-discussion-only').show();
  $('#discussion-your-comment-label').text("Start the team conversation with a question or comment:")
  $('#discussion #invite-guest').toggle(discussion_info.can_invite);
  if (!is_page_load) $('#discussion-your-comment').focus();

  // fill in the context block on the right side
  $('#discussion .fillin-project_name').text(discussion_info.project.title);
  if (discussion.guests.length > 0 || 1) {
    // show guest count & names
    var text = " and " + discussion.guests.length + " guest";
    if (discussion.guests.length != 1) text += "s";
    if (discussion.guests.length > 1) {
      text += " (";
      for (var i = 0; i < discussion.guests.length; i++) {
        text += discussion.guests[i].name;
        if (i < discussion.guests.length-1)
          text += ", ";
      }
      text += ")";
    }
    $('#discussion .fillin-guests').text(text);
  }

  // for polling, what did we last see
  discussion_info.max_comment_id = 0;
  discussion_info.max_event_time = 0;

  // render events
  $('#discussion .comment-thread').html('');
  render_events(discussion);

  // Autocomplete. The discussion object has a mapping from trigger
  // characters to autocomplete possibilities:
  //
  // {
  //   "@": [{
  //             "tag": "thing the autocomplete inserts",
  //             "display": "text displayed in the autocomplete popup",
  //         }, ... ]
  // }
  function make_autocomplete_strategy(trigger_character) {
    var autocomplete = discussion.autocomplete[trigger_character];

    RegExp.escape = function(s) {
      // http://stackoverflow.com/a/18151038
      return String(s).replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g, '\\$1').
      replace(/\x08/g, '\\x08');
    };
    return {
      match: new RegExp("(^|\\s)" + RegExp.escape(trigger_character) + "(\\w*)$"),
      search: function (term, callback, match) {
        // Perform a search.
        var matches = [];
        term = match[2].toLowerCase().replace(/ /, "");
        for (var i = 0; i < autocomplete.length; i++) {
          var item = autocomplete[i];
          var search_key = (item.tag + item.display).toLowerCase().replace(/ /, "");
          if (search_key.indexOf(term) >= 0) {
            matches.push(item);
          }
        }
        callback(matches)
      },
      template: function(value) {
        if (!value.display)
          return value.tag;
        var node = $("<span><span class='display'/> <span class='tag' style='font-style: italic; padding-left: 1.5em;'/></span>");
        node.find(".display").text(value.display);
        node.find(".tag").text(value.tag);
        return node.html();
      },
      replace: function(value, event) { return "$1" + (trigger_character + value.tag).replace(/\$/g, "$$$$") + " "; } // must escape any dollar signs in the replacement text, and since we're using replace to do it we need to escape the literal $ twice!
    }
  };
  $('#discussion-your-comment').textcomplete(
    Object.keys(discussion.autocomplete).map(make_autocomplete_strategy)
  , {
    // options
  });

  // start polling the server for new events
  discussion_poll();
}

function render_events(discussion) {
  discussion.events.forEach(function(item) {
    if (item.type == "event")
        render_event(item)
    else if (item.type == "comment")
        render_comment(item);
  });
}

function discussion_poll() {
  setTimeout(function() {
    $.ajax({
        url: "{% url 'start_a_discussion' %}",
        method: "POST",
        data: {
            task: {{task.id}},
            question: "{{q.id|escapejs}}",
            comment_since: discussion_info.max_comment_id,
            event_since: discussion_info.max_event_time
        },
        success: function(res) {
          render_events(res);
          show_notification(res);
          discussion_poll(); // poll again
        }
    })
    },

    // poll interval (10s)
    10000);
}

function show_notification(discussion) {
  function truncate(string) {
    if (string.length > 60)
      string = string.substring(0, 57) + "...";
    return string;
  }

  var notification = "";
  discussion.events.forEach(function(item) {
    notification += truncate(item.notification_text) + "\n\n";
  })

  // if there's anything to show, show it
  if (notification.length > 0)
    Push.create(discussion.discussion.title, {
      body: notification,
      /*icon: {
          x16: 'images/icon-x16.png',
          x32: 'images/icon-x32.png'
      },*/
      timeout: 5000
  });
}

function render_comment(item) {
  // Update existing DOM node?
  var n = $('#discussion .comment[data-id=ID], #discussion .reply[data-id=ID]'.replace(/ID/g, item.id));
  var isnew = false;
  if (n.length == 0) {
    // Create and fill in a DOM node.
    n = (!item.replies_to ? $('#comment-template') : $('#reply-template')).find('> div').clone();
    isnew = true;
  }

  // Skip if the reaction is empty, i.e. if the emojis were edited-away.
  if (item.replies_to && !item.emojis) {
    n.remove();
    return;
  }

  // Fill in.
  n.attr('data-id', item.id);
  n.attr('data-sort-order', item.date_posix);
  if (item.user && item.user.picture)
    n.find('.comment-avatar').attr('src', item.user.picture.url).show();
  else
    n.find('.comment-avatar').hide();
  n.find('.comment-author').text(item.user.name);
  n.find('.comment-date').text(item.date_relative);
  n.find('.comment-date').attr('title', new Date(item.date_posix * 1000));
  n.find('.comment-author-role').text(item.user_role);
  n.find('.comment-text').html(item.text_rendered);
  n.attr('data-text', item.text);
  if (item.user.id == {{request.user.id}}) // TODO: admins too
    n.addClass('has-edit-priv');
  if (item.user.id == {{request.user.id}})
    n.addClass('author-is-self');
  n.find('.comment-emojis').html('');
  if (item.emojis) {
    n.attr('data-emojis', item.emojis.join(','));
    item.emojis.forEach(function(item) {
      n.find('.comment-emojis').append(emojione.toImage(":" + item + ":"))
    })
  }

  // The rest is only if we're seeing a new comment.
  if (!isnew)
    return;

  // Update state - if any comments are present, change label.
  $('#discussion-your-comment-label').text("Add your comment:")
  discussion_has_any_comment = true;
  if (item.user.id != {{request.user.id}})
    discussion_has_any_comment_from_someone_else = true;
  var show_youre_alone = discussion_has_any_comment && !discussion_has_any_comment_from_someone_else;
  $('#discussion-you-are-alone').toggle(show_youre_alone && discussion_info.can_invite);
  $('#discussion #invite-guest').toggle(!show_youre_alone && discussion_info.can_invite);

  // Event handlers.
  n.find('textarea').keydown(textarea_ctrlenter_handler);

  // Add to the DOM.
  if (!item.replies_to) {
    var c = $('#discussion .comment-thread');
    c.append(n);
  } else {
    var parent = $('#discussion .comment[data-id=' + item.replies_to + ']');
    parent.find('.reactions').append(n);
  }

  // Remember the last comment we've seen, for polling.
  if (item.id > discussion_info.max_comment_id)
    discussion_info.max_comment_id = item.id;

  // Scroll here if the window location fragment targets this.
  if (window.location.hash == "#discussion-comment-" + item.id)
    smooth_scroll_to(n);
}

function render_event(item) {
  var n = $('#event-template > div').clone();
  n.attr('data-sort-order', item.date_posix);

  n.find('.body').html(item.html);
  n.find('.event-date').text(item.date_relative);
  n.find('.event-date').attr('title', new Date(item.date_posix * 1000));
  if (item.who && !item.who_is_in_text)
    n.find('.event-who').text("by " + item.who.name);
  if (item.who && item.who.picture)
    n.find('.event-icon img').attr('src', item.who.picture.url).show();

  var c = $('#discussion .comment-thread')
  c.append(n);


  // Remember the last event we've seen, for polling.
  if (item.date_posix > discussion_info.max_event_time)
    discussion_info.max_event_time = item.date_posix;
}

function submit_comment() {
  ajax_with_indicator({
    url: "{% url 'discussion-comment-create' %}",
    method: "POST",
    data: {
      discussion: discussion_info.id,
      text: $('#discussion .comment-input form textarea').val()
    },
    controls: $('#discussion .comment-input form').find('textarea, input, button'),
    success: function(c) {
      // keep the window scrolled such that the input box stays
      // in the same place -- i.e., the new comment pushes things
      // up.
      var y = $('#discussion .comment-input').offset().top - $(window).scrollTop();

      $('#discussion .comment-input form textarea').val('');
      render_comment(c)

      // adjust scroll position
      $(window).scrollTop($('#discussion .comment-input').offset().top - y);
    }
  })
}

function get_comment_from_command_elem(command_elem) {
  var c = $(command_elem).parents(".comment");
  if (c.length == 0) throw "something went wrong";
  return c;
}

function begin_comment_edit(command_elem) {
  var c = get_comment_from_command_elem(command_elem);
  c.find('.commands').hide();
  c.find('.comment-edit textarea').css({ minHeight: c.find('.comment-text').height()+30 });
  c.find('.comment-edit textarea').val(c.attr('data-text'));
  c.find('.comment-text').hide();
  c.find('.comment-edit').show();
  return false;
}

function close_comment_edit(command_elem) {
  var c = get_comment_from_command_elem(command_elem);
  c.find('.commands').show();
  c.find('.comment-text').show();
  c.find('.comment-edit').hide();
  return false;
}

function do_comment_save(command_elem) {
  var c = get_comment_from_command_elem(command_elem);
  ajax_with_indicator({
    url: "{% url 'discussion-comment-edit' %}",
    method: "POST",
    data: {
      id: c.attr('data-id'),
      text: c.find('.comment-edit textarea').val()
    },
    controls: c.find('textarea, input, button'),
    success: function(res) {
      // update UI
      render_comment(res);
      close_comment_edit(command_elem);
    }
  })
}

function do_delete_comment(command_elem) {
  var c = get_comment_from_command_elem(command_elem);
  show_modal_confirm(
    "Delete Comment",
    "Are you sure you want to delete that comment?",
    "Delete",
    function() {
      ajax_with_indicator({
        url: "{% url 'discussion-comment-delete' %}",
        method: "POST",
        data: {
          id: c.attr('data-id')
        },
        success: function(res) {
          c.slideUp();
        }
      })
    });
  return false;
}

var current_emoji_reaction = null;

function begin_emoji_reaction(event, command_elem) {
  // We have a click handler on the document to close the
  // reaction dialog. But clicking on the button to open
  // the dialog should not propagate and trigger that.
  event.stopPropagation();

  // Save any emoji reaction currently being edited.
  if (current_emoji_reaction)
    save_emoji_reaction();

  // Initialize and show.
  var c = get_comment_from_command_elem(command_elem);
  current_emoji_reaction = c;
  var et = c.find('.commands .react-with-emoji');
  var es = $('#emoji-selector');

  // reset state to previously reacted emojis
  es.find('.emoji').removeClass('active');
  var emojis = c.find('.reactions .author-is-self').attr('data-emojis');
  if (emojis) {
    emojis.split(',').forEach(function(shortname) {
      es.find('.emoji').each(function() {
        if (this.getAttribute('data-emoji-name') == shortname)
          $(this).addClass('active');
      });
    });
  }

  es.css({
    display: 'block',
    position: 'absolute',
    width: '20em',
    left: et.position().left + et.width() + 5, // using position() rather than offset() because we're witihn a relatively positioned column (and the pop-up is defined within the same col, so that's ok)
    top: et.position().top - 30
  })
  return false;
}

function save_emoji_reaction() {
  var es = $('#emoji-selector').hide();
  if (!current_emoji_reaction)
    return;

  // what emojis are selected
  var emojis = [];
  es.find('.emoji.active').each(function() {
    emojis.push($(this).attr('data-emoji-name'));
  })

  // update db
  ajax_with_indicator({
    url: "{% url 'discussion-comment-react' %}",
    method: "POST",
    data: {
      id: current_emoji_reaction.attr('data-id'),
      emojis: emojis.join(",")
    },
    success: function(res) {
      // updates UI
      render_comment(res);
    }
  })
  current_emoji_reaction = null;
}

function invite_user_to_discussion() {
  show_invite_modal(
    'Invite to Discussion',
    'Invite a colleague to join the discussion. They will be a guest of this discussion if they are not added to the project team.',
    {{send_invitation|safe}},
    'Please join our discussion about ' + discussion_info.title + ' in ' + discussion_info.project.title + '.',
    {
      project: discussion_info.project.id,
      into_discussion: discussion_info.id
    }
  );
  return false;
}
</script>